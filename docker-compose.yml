version: '3.8'

# ═══════════════════════════════════════════════════════════════════════════════
#  PQC CyberSec Simulator - Docker Compose
# ═══════════════════════════════════════════════════════════════════════════════
#  
#  This Docker Compose runs ONLY the legitimate government services.
#  The Hacker Console runs LOCALLY (outside Docker) to simulate external attacker.
#
#  Quick Start:
#    docker-compose up -d
#
#  Services:
#    - PostgreSQL:       localhost:5432
#    - Government Portal: localhost:8181  (Web UI + API)
#    - Secure Messaging:  localhost:8182  (API only)
#    - pgAdmin:          localhost:5050  (optional DB admin)
#
#  Hacker Console (run separately):
#    cd hacker-console
#    mvn spring-boot:run -Dspring-boot.run.profiles=standalone
#
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ═══════════════════════════════════════════════════════════════
  #  DATABASE: PostgreSQL 16
  # ═══════════════════════════════════════════════════════════════
  postgres:
    image: postgres:16-alpine
    container_name: pqc-postgres
    environment:
      POSTGRES_DB: pqc_cybersec
      POSTGRES_USER: pqc_admin
      POSTGRES_PASSWORD: PqcSecure2024!
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U pqc_admin -d pqc_cybersec" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pqc-network

  # ═══════════════════════════════════════════════════════════════
  #  SERVICE 1: Government Portal (Web UI + API)
  # ═══════════════════════════════════════════════════════════════
  #
  #  Features:
  #    - User registration & login
  #    - Car License application forms
  #    - Tax Filing forms
  #    - Officer document approval
  #    - PQC & Classical encryption options
  #
  #  Web UI: http://localhost:8181
  #
  #  Demo Accounts:
  #    - admin / Admin@PQC2024!
  #    - officer / Officer@2024!
  #    - john.citizen / Citizen@2024!
  #    - emily.chen / Citizen@2024!
  #
  gov-portal:
    build:
      context: .
      dockerfile: gov-portal/Dockerfile
    container_name: gov-portal
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/pqc_cybersec
      SPRING_DATASOURCE_USERNAME: pqc_admin
      SPRING_DATASOURCE_PASSWORD: PqcSecure2024!
      JWT_SECRET: PqcJwtSecretKey2024ForQuantumResistantSecurity!
    ports:
      - "8181:8181"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - pqc-network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  #  SERVICE 2: Secure Messaging Service (API)
  # ═══════════════════════════════════════════════════════════════
  #
  #  Features:
  #    - Encrypted messaging between users
  #    - ML-KEM-768 key encapsulation
  #    - RSA-2048 fallback option
  #
  #  API: http://localhost:8182
  #
  secure-messaging:
    build:
      context: .
      dockerfile: secure-messaging/Dockerfile
    container_name: secure-messaging
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/pqc_cybersec
      SPRING_DATASOURCE_USERNAME: pqc_admin
      SPRING_DATASOURCE_PASSWORD: PqcSecure2024!
      USER_SERVICE_URL: http://gov-portal:8181
    ports:
      - "8182:8182"
    depends_on:
      postgres:
        condition: service_healthy
      gov-portal:
        condition: service_started
    networks:
      - pqc-network
    restart: unless-stopped

  # ═══════════════════════════════════════════════════════════════
  #  pgAdmin (Optional - Database Management)
  # ═══════════════════════════════════════════════════════════════
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pqc-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@pqc.local
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - pqc-network
    restart: unless-stopped
    profiles:
      - tools

# ═══════════════════════════════════════════════════════════════════════════════
#  HACKER CONSOLE - RUNS LOCALLY (NOT IN DOCKER)
# ═══════════════════════════════════════════════════════════════════════════════
#
#  The Hacker Console intentionally runs OUTSIDE Docker to simulate:
#    ✓ External threat actor (realistic attack scenario)
#    ✓ Network-level interception
#    ✓ "Harvest Now, Decrypt Later" (HNDL) attacks
#    ✓ Quantum computer access simulation
#
#  To run the Hacker Console:
#
#    Option 1: Use the batch script
#      start-hacker-standalone.bat     (Windows)
#      ./start-hacker-standalone.sh    (Linux/Mac)
#
#    Option 2: Run manually
#      cd hacker-console
#      mvn spring-boot:run -Dspring-boot.run.profiles=standalone
#
#  Hacker Console URL: http://localhost:8083
#
# ═══════════════════════════════════════════════════════════════════════════════

volumes:
  postgres_data:

networks:
  pqc-network:
    driver: bridge
